{
  "issue_id": 6908,
  "issue_url": "https://github.com/apache/rocketmq/issues/6908",
  "title": "[Bug] The proxy in the cluster mode obtains the wrong address of the broker",
  "description_text": "### Before Creating the Bug Report\n\n- [X] I found a bug, not just asking a question, which should be created in [GitHub Discussions](https://github.com/apache/rocketmq/discussions).\n\n- [X] I have searched the [GitHub Issues](https://github.com/apache/rocketmq/issues) and [GitHub Discussions](https://github.com/apache/rocketmq/discussions)  of this repository and believe that this is not a duplicate.\n\n- [X] I have confirmed that this bug belongs to the current repository, not other repositories of RocketMQ.\n\n\n### Runtime platform environment\n\nOS: CentOS 6.9\n\n### RocketMQ version\n\nbranch: (develop|tag 5.1.1) version: 5.1.1\n\n### JDK Version\n\nJDK: 1.8.0_202\n\n### Describe the Bug\n\nWhen I connect to the clustered proxy to consume messages using the remoting protocol, some messages from one broker cannot be consumed. \r\nAfter debugging, I found that the obtained offset of broker is wrong.\r\n![bug](https://github.com/apache/rocketmq/assets/10137071/c3b88b07-33f5-4365-8ec2-e078b0c5915e)\r\n\r\nAs shown in the figure above, when [`ClusterTopicRouteService.getBrokerAddr()`](https://github.com/apache/rocketmq/blob/develop/proxy/src/main/java/org/apache/rocketmq/proxy/service/route/ClusterTopicRouteService.java#L66) obtains the broker address, the brokerName in the **parameter is broker-a**, but the **obtained address is broker-b**.\n\n### Steps to Reproduce\n\n1. Deploy a new broker-a, start it.\r\n2. Create some topics in broker-a for testing, such as message produing and consuming, that is not important.\r\n4. When I deploy a new broker, such as broker-b,  I need **copy topics.json from broker-a to broker-b**, then start it.\r\n5. Now broker-b\u2018s topics have broker-a and broker-b.\r\n\r\nWhen [`ClusterTopicRouteService.getBrokerAddr()`](https://github.com/apache/rocketmq/blob/develop/proxy/src/main/java/org/apache/rocketmq/proxy/service/route/ClusterTopicRouteService.java#L66) obtains the broker address, the code's logic did not consider this situation(Topic `broker-a` exist in broker-a and broker-b), so got the wrong broker addr.\n\n### What Did You Expect to See?\n\nGot the right broker addr.\n\n### What Did You See Instead?\n\nGot the wrong broker addr.\n\n### Additional Context\n\n_No response_"
}